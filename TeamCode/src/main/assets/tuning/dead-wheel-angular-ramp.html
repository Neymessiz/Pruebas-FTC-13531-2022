<!doctype html>
<html>
  <head>
    <title>RR Dead Wheel Angular Ramp Regression</title>

    <style>
body {
  font-family: Arial, Helvetica, sans-serif;
}

.content {
  max-width: 600px;
  margin: auto;
}

.bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

fieldset {
  display: flex;
  justify-content: space-between;
}
    </style>

    <script src="/tuning/plotly-2.12.1.min.js"></script>

    <!-- https://tom-alexander.github.io/regression-js/ -->
    <script src="/tuning/regression-2.0.1.min.js"></script>

    <!-- <script src="/tuning/common.js"></script> -->
    <script src="common.js"></script>
  </head>
  <body>
    <div class="content">
      <h1>RR Dead Wheel Angular Ramp Regression</h1>
      <p></p> 
      
      <div id="deadWheelCharts"></div>

      <fieldset>
        <legend>Feedforward Parameters</legend>
        <div>
          kV: <input id="kv" type="text" />
        </div>
        <div>
          kS: <input id="ks" type="text" />
        </div>
        <input id="update" type="button" value="update" />
      </fieldset>
    
      <div id="trackWidthChart">Loading...</div>
    </div>

    <script>
const trackWidthChartDiv = document.getElementById('trackWidthChart');
fetch('/tuning/angular-ramp/latest.json')
  .then(res => {
    if (res.ok) {
      return res.json();
    } else {
      trackWidthChartDiv.innerText = 'No data files found';
      throw new Error();
    }
  })
  .then(data => {
    const [_, angVels] = data.angVels.reduce((acc, vsArg) => {
      const vs = vsArg.map(v => Math.abs(v));
      const maxV = vs.reduce((acc, v) => Math.max(acc, v), 0);
      const [accMaxV, _] = acc;
      if (maxV >= accMaxV) {
        return [maxV, vs];
      }
      return acc;
    }, [0, []]);
    
    const deadWheelCharts = document.getElementById('deadWheelCharts');
    data.parEncVels.forEach((vs, i) => {
      const div = document.createElement('div');
      newLinearRegressionChart(div, 
        angVels.slice(1, angVels.length - 1),
        fixVels(data.encTimes, data.parEncPositions[i], vs),
        {title: `Parallel Wheel ${i} Regression`, slope: 'y-position'});
      deadWheelCharts.appendChild(div);
    });
    data.perpEncVels.forEach((vs, i) => {
      const div = document.createElement('div');
      newLinearRegressionChart(div, 
        angVels.slice(1, angVels.length - 1),
        fixVels(data.encTimes, data.perpEncPositions[i], vs),
        {title: `Perpendicular Wheel ${i} Regression`, slope: 'x-position'});
      deadWheelCharts.appendChild(div);
    });

    const setParams = (() => {
      const appliedVoltages = data.voltages.map((v, i) => 
        [...data.leftPowers, ...data.rightPowers].reduce((acc, ps) => Math.max(acc, ps[i]), 0) * v);

      const setTrackWidthData = newLinearRegressionChart(
        trackWidthChartDiv,
        [], [],
        {title: 'Track Width Regression', slope: 'track width'}
      );

      return (kV, kS) => setTrackWidthData(angVels, appliedVoltages.map((v, i) => 
        (v - kS) / kV * (data.type === 'mecanum' ? 2 : 1)));
    })();

    const kvInput = document.getElementById('kv');
    const ksInput = document.getElementById('ks');
    document.getElementById('update').addEventListener('click', () => {
      setParams(parseFloat(kvInput.value), parseFloat(ksInput.value));
    });
  })
  .catch(console.log.bind(console));
    </script>
  </body>
</html>

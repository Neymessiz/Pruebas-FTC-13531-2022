<!doctype html>
<html>
  <head>
    <title>RR Acceleration Regression</title>

    <style>
body {
  font-family: Arial, Helvetica, sans-serif;
}

.content {
  max-width: 600px;
  margin: auto;
}

.bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

fieldset {
  display: flex;
  justify-content: space-between;
}
    </style>

    <script src="/tuning/plotly-2.12.1.min.js"></script>

    <!-- https://tom-alexander.github.io/regression-js/ -->
    <script src="/tuning/regression-2.0.1.min.js"></script>

    <!-- <script src="/tuning/common.js"></script> -->
    <script src="common.js"></script>
  </head>
  <body>
    <div class="content">
      <h1>RR Acceleration Regression</h1>
      <p></p>

      <div id="download"></div>

      <fieldset>
        <legend>Feedforward Parameters</legend>
        <div>
          kV: <input id="kv" type="text" />
        </div>
        <div>
          kS: <input id="ks" type="text" />
        </div>
        <input id="update" type="button" value="update" />
      </fieldset>
      
      <div id="accelChart">
        <p>
          <button id="latest">Latest</button>
          <input id="browse" type="file" accept="application/json">
        </p>
      </div>
    </div>

    <script>
function loadRegression(data) {
  const setParams = (function() {
    const forwardEncVels = data.forwardEncVels.map((vs, i) => 
      fixVels(data.encTimes, data.forwardEncPositions[i], vs));
    const as = forwardEncVels.flatMap(vs => numDerivOffline(data.encTimes, vs));

    const setAccelData = newLinearRegressionChart(
      document.getElementById('accelChart'),
      [], [],
      {title: 'Acceleration Regression', slope: 'kA'}
    );

    return (kV, kS) => {
      const vs = data.powers.flatMap((ps, i) => {
        const voltages = ps.map((p, j) => {
          const explainedVoltage = kS + kV * forwardEncVels[i][j];
          const totalVoltage = p * data.voltages[j]; 
          return totalVoltage - explainedVoltage;
        });
        
        return voltages.slice(2, voltages.length - 2);
      });
      
      setAccelData(as, vs);
    };
  })();

  const kvInput = document.getElementById('kv');
  const ksInput = document.getElementById('ks');
  document.getElementById('update').addEventListener('click', () => {
    setParams(parseFloat(kvInput.value), parseFloat(ksInput.value));
  });
}

const latestButton = document.getElementById('latest');
latestButton.addEventListener('click', function() {
  fetch('/tuning/accel/latest.json')
    .then(res => {
      if (res.ok) {
        const filename = res.headers.get('X-Filename');

        const a = document.createElement('a');
        a.innerText = 'Download';
        a.href = `/tuning/forward-ramp/${filename}`;
        a.download = `forward-ramp-${filename}`;

        document.getElementById('download').appendChild(a);

        return res.json();
      } else {
        document.getElementById('accelChart').innerText = 'No data files found';
        throw new Error();
      }
    })
    .then(loadRegression)
    .catch(console.log.bind(console));
});

const browseInput = document.getElementById('browse');
browseInput.addEventListener('change', function(evt) {
  const reader = new FileReader();
  reader.onload = function() {
    loadRegression(JSON.parse(reader.result.trim()));
  };

  reader.readAsText(browseInput.files[0]);
});
    </script>
  </body>
</html>
